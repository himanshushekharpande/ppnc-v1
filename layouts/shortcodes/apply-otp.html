<div class="max-w-3xl mx-auto my-12 px-6">
  <h2 class="text-2xl font-bold mb-6 text-marian-blue">Application Form</h2>

  <!-- OTP Verification Step -->
  <div id="otp-step" class="space-y-6 bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
    <h3 class="text-lg font-semibold text-gray-800">Mobile Verification</h3>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700">Mobile Number</label>
      <input id="phone" type="tel" required 
             pattern="[6-9][0-9]{9}" 
             placeholder="98XXXXXX20"
             class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
      <p class="text-xs text-gray-500 mt-1">10-digit Indian mobile number</p>
    </div>
    
    <button type="button" id="send-otp" 
            class="w-full px-4 py-2 bg-marian-blue text-white rounded-md hover:bg-resolution-blue transition">
      Send OTP
    </button>

    <div id="verify-otp-section" class="hidden space-y-4">
      <div>
        <label for="otp" class="block text-sm font-medium text-gray-700">Enter OTP</label>
        <input id="otp" type="text" pattern="[0-9]{6}" maxlength="6" placeholder="000000"
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm text-center text-lg font-semibold">
      </div>
      
      <div class="flex gap-2">
        <button type="button" id="verify-otp" 
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
          Verify OTP
        </button>
        <button type="button" id="resend-otp" 
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
          Resend
        </button>
      </div>
    </div>
  </div>

  <!-- Application Form -->
  <form id="apply-form" class="hidden space-y-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
    <input type="hidden" name="form_type" value="application">
    <input type="hidden" name="verified_phone" id="verified-phone">
    <input type="hidden" name="redirect" value="{{ "admissions/thank-you/" | absURL }}">
    <input type="hidden" name="referer" id="referer-apply">
    <input type="hidden" name="t0" id="t0-apply">

    <!-- Honeypot -->
    <div class="hidden">
      <label>Leave this field empty</label>
      <input type="text" name="website" autocomplete="off">
    </div>

    <div class="grid sm:grid-cols-2 gap-4">
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700">Full Name *</label>
        <input id="name" name="name" required
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Verified Mobile</label>
        <input type="text" id="verified-phone-display" disabled
               class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 sm:text-sm">
      </div>
    </div>

    <div class="grid sm:grid-cols-2 gap-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
        <input id="email" type="email" name="email" required
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
      </div>
      <!-- Parent's Mobile removed as requested -->
    </div>

    <!-- NEW: State of Residence -->
    <div>
      <label for="state" class="block text-sm font-medium text-gray-700">State of Residence *</label>
      <select id="state" name="state" required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
        <option value="">Select</option>
        <!-- States (28) -->
        <option>Andhra Pradesh</option>
        <option>Arunachal Pradesh</option>
        <option>Assam</option>
        <option>Bihar</option>
        <option>Chhattisgarh</option>
        <option>Goa</option>
        <option>Gujarat</option>
        <option>Haryana</option>
        <option>Himachal Pradesh</option>
        <option>Jharkhand</option>
        <option>Karnataka</option>
        <option>Kerala</option>
        <option>Madhya Pradesh</option>
        <option>Maharashtra</option>
        <option>Manipur</option>
        <option>Meghalaya</option>
        <option>Mizoram</option>
        <option>Nagaland</option>
        <option>Odisha</option>
        <option>Punjab</option>
        <option>Rajasthan</option>
        <option>Sikkim</option>
        <option>Tamil Nadu</option>
        <option>Telangana</option>
        <option>Tripura</option>
        <option>Uttar Pradesh</option>
        <option>Uttarakhand</option>
        <option>West Bengal</option>
        <!-- Union Territories (8) -->
        <option>Andaman and Nicobar Islands</option>
        <option>Chandigarh</option>
        <option>Dadra and Nagar Haveli and Daman and Diu</option>
        <option>Delhi</option>
        <option>Jammu and Kashmir</option>
        <option>Ladakh</option>
        <option>Lakshadweep</option>
        <option>Puducherry</option>
      </select>
    </div>

    <div class="border-t pt-6">
      <h4 class="text-lg font-semibold text-marian-blue mb-4">Educational Details</h4>
      
      <div class="space-y-4">
        <div>
          <label for="qualification" class="block text-sm font-medium text-gray-700">Highest Qualification *</label>
          <select id="qualification" name="qualification" required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
            <option value="">Select</option>
            <option value="10th">10th Standard</option>
            <option value="12th">12th Standard</option>
            <!-- "Graduate" removed as requested -->
          </select>
        </div>

        <div>
          <label for="program" class="block text-sm font-medium text-gray-700">Program *</label>
          <select id="program" name="program" required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm">
            <option value="">Select</option>
            <option value="GNM">GNM Nursing</option>
            <option value="BSc Nursing">B.Sc Nursing</option>
          </select>
        </div>
      </div>
    </div>

    <div>
      <label for="message" class="block text-sm font-medium text-gray-700">Additional Information</label>
      <textarea id="message" name="message" rows="4"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-marian-blue focus:ring-marian-blue sm:text-sm"></textarea>
    </div>

    <button type="submit"
            class="w-full px-5 py-3 rounded-lg bg-marian-blue text-white font-semibold hover:bg-resolution-blue transition">
      Submit Application
    </button>
  </form>
  
  <div id="recaptcha-container"></div>
  <!-- Firebase SDK - LOAD THESE SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <script>
    (function(){

    // Helpers
    function phoneOK(v){ return /^[6-9]\d{9}$/.test(String(v||"").trim()); }
    function e164FromLocal(p10){ return '+91' + p10.replace(/\D/g,'').slice(-10); }
    async function postJSON(url, obj) {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(obj) });
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(e){ return { ok:false, status: res.status, raw: txt }; }
    }

    // UI elements (ensure IDs match your HTML)
    const sendBtnId = 'send-otp';
    const resendBtnId = 'resend-otp';
    const verifyBtnId = 'verify-otp';
    const phoneId = 'phone';
    const otpId = 'otp';
    const verifySectionId = 'verify-otp-section';
    const otpStepId = 'otp-step';
    const applyFormId = 'apply-form';
    const verifiedPhoneInputId = 'verified-phone';
    const verifiedPhoneDisplayId = 'verified-phone-display';
    const refererId = 'referer-apply';
    const t0Id = 't0-apply';

    let currentTx = null;
    let lastPhoneSent = null;

    // DOM ready
    document.addEventListener('DOMContentLoaded', function(){

      // init hidden fields
      const refererEl = document.getElementById(refererId);
      const t0El = document.getElementById(t0Id);
      if (refererEl) refererEl.value = location.href;
      if (t0El) t0El.value = Date.now();

      const sendBtn = document.getElementById(sendBtnId);
      const resendBtn = document.getElementById(resendBtnId);
      const verifyBtn = document.getElementById(verifyBtnId);
      const phoneEl = document.getElementById(phoneId);
      const otpEl = document.getElementById(otpId);
      const verifySection = document.getElementById(verifySectionId);
      const otpStep = document.getElementById(otpStepId);
      const applyForm = document.getElementById(applyFormId);
      const verifiedHidden = document.getElementById(verifiedPhoneInputId);
      const verifiedDisplay = document.getElementById(verifiedPhoneDisplayId);

      // Safety: ensure expected elements exist
      if (!sendBtn || !verifyBtn || !phoneEl || !otpEl || !verifiedHidden || !verifiedDisplay) {
        console.warn('OTP script: missing expected DOM elements. Check IDs.');
        return;
      }

      // Clean UI state
      if (verifySection) verifySection.classList.add('hidden');
      if (applyForm) applyForm.classList.add('hidden');

      // Send OTP handler
      sendBtn.addEventListener('click', async () => {
        const p10 = phoneEl.value.trim();
        if (!phoneOK(p10)) { alert('Please enter valid 10-digit Indian number (starts 6–9)'); return; }

        sendBtn.disabled = true;
        const prevText = sendBtn.textContent;
        sendBtn.textContent = 'Sending...';

        const phoneFull = '91' + p10;
        const resp = await postJSON('/api/send-otp', { phone: phoneFull });

        if (!resp || !resp.ok) {
          const msg = (resp && (resp.error || resp.message)) || 'Failed to send OTP. Try again later.';
          alert('Send OTP failed: ' + msg);
          sendBtn.disabled = false;
          sendBtn.textContent = prevText;
          return;
        }

        // success
        currentTx = resp.tx || resp.result?.tx || null;
        lastPhoneSent = phoneFull;
        if (verifySection) verifySection.classList.remove('hidden');
        sendBtn.textContent = 'OTP Sent';
        // enable resend after short delay
        if (resendBtn) {
          resendBtn.disabled = true;
          setTimeout(()=> { if(resendBtn) resendBtn.disabled = false; }, 15000); // 15s before allowed resend
        }
      });

      // Resend handler (calls same endpoint again)
      if (resendBtn) {
        resendBtn.addEventListener('click', async () => {
          const p10 = phoneEl.value.trim();
          if (!phoneOK(p10)) { alert('Please enter valid 10-digit Indian number'); return; }
          resendBtn.disabled = true;
          resendBtn.textContent = 'Resending...';

          const phoneFull = '91' + p10;
          // optional: if lastPhoneSent !== phoneFull, reset currentTx
          if (lastPhoneSent && lastPhoneSent !== phoneFull) currentTx = null;

          const resp = await postJSON('/api/send-otp', { phone: phoneFull });
          if (!resp || !resp.ok) {
            alert('Resend failed: ' + (resp.error || JSON.stringify(resp)));
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend';
            return;
          }

          currentTx = resp.tx || currentTx;
          lastPhoneSent = phoneFull;
          resendBtn.textContent = 'OTP Sent';
          setTimeout(()=> { if(resendBtn) { resendBtn.disabled = false; resendBtn.textContent = 'Resend'; } }, 15000);
        });
      }

      // Verify handler
      verifyBtn.addEventListener('click', async () => {
        const code = otpEl.value.trim();
        if (!/^\d{6}$/.test(code)) { alert('Please enter 6-digit OTP'); return; }
        if (!currentTx) { alert('No OTP transaction found. Please send OTP first.'); return; }

        verifyBtn.disabled = true;
        const prevText = verifyBtn.textContent;
        verifyBtn.textContent = 'Verifying...';

        const resp = await postJSON('/api/verify-otp', { tx: currentTx, otp: code });

        if (!resp || !resp.ok) {
          const errMsg = (resp && (resp.error || resp.message)) || 'Verification failed.';
          alert('OTP verify failed: ' + errMsg);
          verifyBtn.disabled = false;
          verifyBtn.textContent = prevText;
          return;
        }

        // success: resp.phone expected in E.164 (e.g. +919812345678)
        const phoneE164 = resp.phone || ('+' + lastPhoneSent);
        verifiedHidden.value = phoneE164;
        verifiedDisplay.value = phoneE164.replace('+91','');

        // advance UI
        if (otpStep) otpStep.classList.add('hidden');
        if (applyForm) applyForm.classList.remove('hidden');

        // clear sensitive variables
        currentTx = null;
        lastPhoneSent = null;
        verifyBtn.disabled = false;
        verifyBtn.textContent = prevText;
      });

      // Form submission: keep your existing GAS submission
      if (applyForm) {
        applyForm.addEventListener('submit', async function(e){
          e.preventDefault();

          // Ensure phone verified
          const e164 = (document.getElementById(verifiedPhoneInputId).value||'').trim();
          if (!e164.startsWith('+91')) { alert('Phone not verified.'); return; }

          // Create FormData and submit to your Apps Script
          const formData = new FormData(this);
          try {
            const res = await fetch('{{ .Site.Params.googleFormEndpoint }}', {
            method: 'POST',
            body: formData
          });

          // Always read text to handle JSON or plain text
          const text = await res.text();
          let data = null;
          try { data = JSON.parse(text); } catch (_) {}

          if (res.ok && data && data.ok) {
            // ✅ Successful JSON response
            const redirect = data.redirect || '{{ "admissions/thank-you/" | absURL }}';
            window.location.href = redirect;
          } else if (res.ok && !data) {
            // Fallback: HTML success response (Apps Script older version)
            window.location.href = '{{ "admissions/thank-you/" | absURL }}';
          } else {
            console.error('Submission failed', { status: res.status, body: text });
            alert('Submission failed. Try again later.');
          }
          } catch (err) {
            console.error('Submission error', err);
            alert('Submission failed. Try again later.');
          }
        });
      }

    }); // DOMContentLoaded end

  })(); // IIFE end
</script>
</div>
